<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>17.2 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∂‡∏á‡∏ú‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î</title>
  <meta name="description" content="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∂‡∏á‡∏ú‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏•" />
  <meta name="theme-color" content="#5b6fe6" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            thai: ['Sarabun', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Sarabun', 'sans-serif'; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    input[type="range"] {
        -webkit-appearance: none; appearance: none;
        width: 100%; height: 8px;
        background: #d1d5db; border-radius: 5px;
        outline: none; opacity: 0.7;
        transition: opacity .2s;
    }
    input[type="range"]:hover { opacity: 1; }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        width: 20px; height: 20px;
        background: #10b981; cursor: pointer;
        border-radius: 50%;
    }
    input[type="range"]::-moz-range-thumb {
        width: 20px; height: 20px;
        background: #10b981; cursor: pointer;
        border-radius: 50%;
    }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
    .control-btn {
        transition: all 0.2s ease-in-out;
    }
    .control-btn-active {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(16, 185, 129, 0.4);
        background-color: #10b981;
        color: white;
        border-color: #059669;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Navigation -->
  <nav class="gradient-bg text-white shadow-lg sticky top-0 z-50" role="navigation" aria-label="‡∏´‡∏•‡∏±‡∏Å">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center" aria-hidden="true">
          <span class="text-2xl">üíß</span>
        </div>
        <h1 class="text-lg sm:text-xl font-bold">17.2 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∂‡∏á‡∏ú‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î</h1>
      </div>
      <a href="index.html" class="text-sm font-semibold hover:text-blue-200 transition-colors">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8 sm:py-12">
    <div class="max-w-4xl mx-auto bg-white p-4 sm:p-8 rounded-lg shadow-lg space-y-12">
      
      <!-- Section 1 -->
      <div>
        <h2 class="text-3xl font-bold text-green-700 mb-6">17.2.1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∂‡∏á‡∏ú‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß</h2>
        <p class="mb-4">
          <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∂‡∏á‡∏ú‡∏¥‡∏ß (Surface Tension, Œ≥)</strong> ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ú‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏à‡∏∞‡∏¢‡∏∂‡∏î‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏£‡∏á‡∏¢‡∏∂‡∏î‡πÄ‡∏´‡∏ô‡∏µ‡πà‡∏¢‡∏ß‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏•‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß (Cohesive force) ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡πÅ‡∏ú‡πà‡∏ô‡∏¢‡∏≤‡∏á‡∏¢‡∏∑‡∏î‡∏ö‡∏≤‡∏á‡πÜ
        </p>
        <div class="mt-2 bg-gray-100 p-4 rounded-lg text-center font-mono text-lg">
          Œ≥ = F / L
        </div>
      </div>

      <hr class="my-8">

      <!-- Section 2 -->
      <div>
        <h2 class="text-3xl font-bold text-green-700 mb-6">17.2.2 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏Å‡∏™‡πå</h2>
        <p class="mb-4">
          <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î (Viscosity, Œ∑)</strong> ‡∏Ñ‡∏∑‡∏≠‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≤‡∏ô‡∏ó‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏• ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏£‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏î‡∏ó‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏• ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏£‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ r ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏• ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏£‡∏á‡∏ï‡πâ‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤ **‡πÅ‡∏£‡∏á‡∏´‡∏ô‡∏∑‡∏î (F‚Çõ)** ‡∏ã‡∏∂‡πà‡∏á‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å **‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏Å‡∏™‡πå (Stoke's Law)**
        </p>
        <div class="mt-2 bg-gray-100 p-4 rounded-lg text-center font-mono text-lg">
          F‚Çõ = 6œÄŒ∑rv
        </div>
      </div>

      <!-- SIMULATION: Stokes' Law -->
      <div class="mt-8 bg-white border border-gray-200 rounded-lg shadow-md p-4 sm:p-6">
          <h4 class="text-xl font-semibold mb-6 text-green-600">üî¨ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á: ‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏Å‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏õ‡∏•‡∏≤‡∏¢</h4>
          <div class="flex flex-col lg:flex-row lg:gap-6">
              <!-- Controls -->
              <div class="lg:w-1/3 lg:order-2 bg-white p-4 sm:p-6 rounded-xl shadow-inner mb-6 lg:mb-0">
                  <div class="space-y-4">
                      <div>
                          <label class="font-medium text-sm mb-2 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏•</label>
                          <div id="fluidButtons" class="grid grid-cols-2 gap-2 text-center text-sm">
                              <button data-viscosity="0.001" data-density="1000" class="control-btn p-2 rounded-lg bg-gray-200 control-btn-active border">‡∏ô‡πâ‡∏≥</button>
                              <button data-viscosity="0.010" data-density="910" class="control-btn p-2 rounded-lg bg-gray-200 border">‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
                              <button data-viscosity="1.48" data-density="1260" class="control-btn p-2 rounded-lg bg-gray-200 border">‡∏Å‡∏•‡∏µ‡πÄ‡∏ã‡∏≠‡∏£‡∏µ‡∏ô</button>
                              <button data-viscosity="10.0" data-density="1420" class="control-btn p-2 rounded-lg bg-gray-200 border">‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á</button>
                          </div>
                      </div>
                       <div>
                          <label class="font-medium text-sm mb-2 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏</label>
                          <div id="objectButtons" class="grid grid-cols-2 gap-2 text-center text-sm">
                              <button data-density="2500" class="control-btn p-2 rounded-lg bg-gray-200 control-btn-active border">‡∏•‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡∏ß</button>
                              <button data-density="7850" class="control-btn p-2 rounded-lg bg-gray-200 border">‡∏•‡∏π‡∏Å‡πÄ‡∏´‡∏•‡πá‡∏Å</button>
                          </div>
                      </div>
                      <div>
                          <label for="radiusSlider" class="font-medium text-sm mb-1 block">‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ (r)</label>
                          <div class="flex items-center gap-2">
                              <input type="range" id="radiusSlider" min="1" max="20" value="5" step="0.5" class="flex-grow">
                              <input type="number" id="radiusNumber" min="1" max="20" value="5" step="0.1" class="w-20 text-center border rounded-md p-1 bg-green-50">
                              <span class="text-xs text-gray-500">mm</span>
                          </div>
                      </div>
                  </div>
                  <hr class="my-6">
                  <div class="text-center p-3 bg-green-50 rounded-lg">
                      <h4 class="font-bold text-green-700">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏õ‡∏•‡∏≤‡∏¢ (v‚Çú)</h4>
                      <p id="terminalVelocityDisplay" class="font-semibold text-2xl mt-1">0.00 m/s</p>
                      <p id="stokesForceDisplay" class="text-xs mt-1">‡πÅ‡∏£‡∏á‡∏´‡∏ô‡∏∑‡∏î (F‚Çõ): 0.00 N</p>
                  </div>
                  <div class="mt-6 space-y-2">
                      <button id="calculateStokesBtn" class="w-full text-center py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition text-base">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
                      <div class="flex gap-2">
                          <button id="clearStokesGraphBtn" class="w-1/2 text-center py-2 bg-yellow-400 hover:bg-yellow-500 text-yellow-800 font-bold rounded-lg transition text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü</button>
                          <button id="exportStokesCsvBtn" class="w-1/2 text-center py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition text-sm">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
                      </div>
                  </div>
              </div>
              <!-- Visuals -->
              <div class="lg:w-2/3 lg:order-1 space-y-4 lg:space-y-6">
                  <div class="w-full flex items-center justify-center bg-white p-4 rounded-xl shadow-inner h-72 sm:h-80 lg:min-h-[350px]">
                      <canvas id="viscosityCanvas"></canvas>
                  </div>
                  <div class="w-full bg-white p-2 sm:p-4 rounded-xl shadow-inner h-64 sm:h-72">
                      <canvas id="viscosityChart"></canvas>
                  </div>
              </div>
          </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="gradient-bg text-white py-8 mt-16" role="contentinfo">
    <div class="container mx-auto px-4 text-center">
       <p class="text-sm text-blue-300">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢: ‡∏ô‡∏≤‡∏¢‡∏ó‡∏£‡∏á‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥ ‡∏™‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡∏ß ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏•‡∏≠‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏û‡∏£‡πà</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const GRAVITY = 9.81;
        let stokesExperimentData = [];
        let stokesChart;
        let animationFrameId;
        let sphereState = { y: 0, v: 0, startY: 0 };

        // --- Utility Functions ---
        function exportToCSV(filename, headers, data) {
            const rows = data.map(d => Object.values(d).join(','));
            const csvString = headers.join(',') + "\n" + rows.join("\n");
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function drawArrow(ctx, fromx, fromy, len, angle, color, label) {
            const tox = fromx + len * Math.cos(angle);
            const toy = fromy + len * Math.sin(angle);
            const headlen = 10;
            const dx = tox - fromx;
            const dy = toy - fromy;
            const arrowAngle = Math.atan2(dy, dx);
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(fromx, fromy);
            ctx.lineTo(tox, toy);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(arrowAngle - Math.PI / 6), toy - headlen * Math.sin(arrowAngle - Math.PI / 6));
            ctx.lineTo(tox - headlen * Math.cos(arrowAngle + Math.PI / 6), toy - headlen * Math.sin(arrowAngle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();
            if (label) {
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 14px Sarabun';
                ctx.textAlign = 'center';
                const isUpArrow = Math.sin(angle) < 0;
                ctx.fillText(label, tox, toy + (isUpArrow ? -15 : 20));
            }
        }
        
        function linkSliderAndNumber(sliderId, numberId) {
            const slider = document.getElementById(sliderId);
            const number = document.getElementById(numberId);
            if(!slider || !number) return;
            slider.addEventListener('input', () => number.value = slider.value);
            number.addEventListener('input', () => slider.value = number.value);
        }

        // --- Simulation Logic ---
        const stokesSim = {
            canvas: document.getElementById('viscosityCanvas'),
            chartCanvas: document.getElementById('viscosityChart'),
            fluidButtons: document.getElementById('fluidButtons'),
            objectButtons: document.getElementById('objectButtons'),
            radiusSlider: document.getElementById('radiusSlider'),
            radiusNumber: document.getElementById('radiusNumber'),
            velocityDisplay: document.getElementById('terminalVelocityDisplay'),
            forceDisplay: document.getElementById('stokesForceDisplay'),
            calculateBtn: document.getElementById('calculateStokesBtn'),
            clearBtn: document.getElementById('clearStokesGraphBtn'),
            exportBtn: document.getElementById('exportStokesCsvBtn'),
        };
        let activeFluidBtn = stokesSim.fluidButtons.querySelector('.control-btn-active');
        let activeObjectBtn = stokesSim.objectButtons.querySelector('.control-btn-active');

        function initializeStokesSim() {
            if (!stokesSim.canvas) return;
            linkSliderAndNumber('radiusSlider', 'radiusNumber');
            const chartCtx = stokesSim.chartCanvas.getContext('2d');
            stokesChart = new Chart(chartCtx, {
                type: 'scatter',
                data: { datasets: [{
                    label: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á', data: [],
                    backgroundColor: 'rgba(16, 185, 129, 0.6)',
                }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏õ‡∏•‡∏≤‡∏¢ (v‚Çú) ‡πÅ‡∏•‡∏∞ ‡∏£‡∏±‡∏®‡∏°‡∏µ¬≤ (r¬≤)', font: { size: 14, family: "'Sarabun', sans-serif" } }
                    },
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: '‡∏£‡∏±‡∏®‡∏°‡∏µ¬≤ (r¬≤) [mm¬≤]' }, min: 0 },
                        y: { title: { display: true, text: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏õ‡∏•‡∏≤‡∏¢ (v‚Çú) [m/s]' }, min: 0 }
                    }
                }
            });
            updateStokesSim(false);
        }

        function drawStokesSim() {
            if (!stokesSim.canvas.getContext) return;
            const ctx = stokesSim.canvas.getContext('2d');
            const W = stokesSim.canvas.width = stokesSim.canvas.parentElement.clientWidth;
            const H = stokesSim.canvas.height = stokesSim.canvas.parentElement.clientHeight;
            const {eta, rho_f} = getFluidProperties();
            const r = parseFloat(stokesSim.radiusSlider.value) / 1000;
            
            ctx.clearRect(0, 0, W, H);

            // Draw fluid container
            const fluidColor = `rgba(107, 114, 128, ${0.1 + (eta / 12) * 0.4})`;
            const containerWidth = W * 0.6;
            const containerX = (W - containerWidth) / 2;
            ctx.fillStyle = fluidColor;
            ctx.fillRect(containerX, 0, containerWidth, H);
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 4;
            ctx.strokeRect(containerX, 0, containerWidth, H);

            // Draw sphere
            const sphereRadiusPixels = 10 + (r * 1000 - 1) * 2;
            sphereState.startY = sphereRadiusPixels + 5;
            const sphereX = W / 2;
            
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.arc(sphereX, sphereState.y, sphereRadiusPixels, 0, 2 * Math.PI);
            ctx.fill();

            // Draw forces
            const {rho_obj} = getObjectProperties();
            const volume = 4/3 * Math.PI * r**3;
            const Fg = rho_obj * volume * GRAVITY;
            const Fb = rho_f * volume * GRAVITY;
            const Fs = 6 * Math.PI * eta * r * sphereState.v;

            const maxForce = Fg * 1.1;
            const arrowScale = H / (maxForce * 4);

            drawArrow(ctx, sphereX, sphereState.y, Fg * arrowScale, Math.PI/2, '#16a34a', 'W');
            drawArrow(ctx, sphereX, sphereState.y, Fb * arrowScale, -Math.PI/2, '#3b82f6', 'F ô');
            drawArrow(ctx, sphereX, sphereState.y, Fs * arrowScale, -Math.PI/2, '#d97706', 'F‚Çõ');
        }

        function animateStokes(terminalVelocity, onFinish) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            
            const H = stokesSim.canvas.height;
            const start = performance.now();
            
            function step(timestamp) {
                const elapsed = timestamp - start;
                const timeScale = 0.05;
                const vt_scaled = terminalVelocity * timeScale * 100;

                sphereState.v = vt_scaled * (1 - Math.exp(-0.005 * elapsed)); // Approach vt
                sphereState.y += sphereState.v * 0.1; // dt
                
                drawStokesSim();
                
                if (sphereState.y < H + 50) {
                   animationFrameId = requestAnimationFrame(step);
                } else {
                    if (onFinish) onFinish();
                }
            }
            animationFrameId = requestAnimationFrame(step);
        }

        function getFluidProperties() {
            return {
                name: activeFluidBtn.textContent,
                eta: parseFloat(activeFluidBtn.dataset.viscosity),
                rho_f: parseFloat(activeFluidBtn.dataset.density)
            };
        }

        function getObjectProperties() {
            return {
                name: activeObjectBtn.textContent,
                rho_obj: parseFloat(activeObjectBtn.dataset.density)
            };
        }
        
        function updateStokesSim(runAnimation = true) {
            if (!stokesSim.radiusSlider) return;
            
            const {eta, rho_f} = getFluidProperties();
            const {rho_obj} = getObjectProperties();
            const r = parseFloat(stokesSim.radiusSlider.value) / 1000;

            const terminalVelocity = (2 * GRAVITY * r**2 * (rho_obj - rho_f)) / (9 * eta);
            const stokesForce = 6 * Math.PI * eta * r * terminalVelocity;

            stokesSim.velocityDisplay.textContent = `${terminalVelocity > 0 ? terminalVelocity.toFixed(3) : '0.000'} m/s`;
            stokesSim.forceDisplay.textContent = `‡πÅ‡∏£‡∏á‡∏´‡∏ô‡∏∑‡∏î (F‚Çõ): ${stokesForce > 0 ? stokesForce.toExponential(2) : '0.00'} N`;
            
            if (runAnimation) {
                sphereState = { y: 25, v: 0, startY: 25 };
                animateStokes(terminalVelocity);
            } else {
                 sphereState = { y: 25, v: 0, startY: 25 };
                 drawStokesSim();
            }
        }

        function logStokesData() {
            const {name: fluidName, eta, rho_f} = getFluidProperties();
            const {name: objName, rho_obj} = getObjectProperties();
            const r_mm = parseFloat(stokesSim.radiusSlider.value);
            const r_m = r_mm / 1000;
            const terminalVelocity = (2 * GRAVITY * r_m**2 * (rho_obj - rho_f)) / (9 * eta);

            if (terminalVelocity > 0) {
                 const dataPoint = {
                    fluidName, objName, radius_mm: r_mm,
                    radius_sq_mm: r_mm**2, terminalVelocity
                };
                stokesExperimentData.push(dataPoint);
                stokesChart.data.datasets[0].data.push({ x: dataPoint.radius_sq_mm, y: dataPoint.terminalVelocity });
                stokesChart.update();
            }
            updateStokesSim(true);
        }

        // --- Event Listeners ---
        stokesSim.fluidButtons.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                activeFluidBtn.classList.remove('control-btn-active');
                btn.classList.add('control-btn-active');
                activeFluidBtn = btn;
                updateStokesSim(true);
            });
        });

        stokesSim.objectButtons.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                activeObjectBtn.classList.remove('control-btn-active');
                btn.classList.add('control-btn-active');
                activeObjectBtn = btn;
                updateStokesSim(true);
            });
        });

        ['input'].forEach(evt => {
            stokesSim.radiusSlider.addEventListener(evt, () => updateStokesSim(false));
            stokesSim.radiusNumber.addEventListener(evt, () => updateStokesSim(false));
        });
        stokesSim.calculateBtn.addEventListener('click', logStokesData);

        stokesSim.clearBtn.addEventListener('click', () => {
            stokesExperimentData = [];
            stokesChart.data.datasets[0].data = [];
            stokesChart.update();
        });

        stokesSim.exportBtn.addEventListener('click', () => {
            const headers = ['‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏•', '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏', '‡∏£‡∏±‡∏®‡∏°‡∏µ (mm)', '‡∏£‡∏±‡∏®‡∏°‡∏µ¬≤ (mm¬≤)', '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏õ‡∏•‡∏≤‡∏¢ (m/s)'];
            exportToCSV('stokes_law_data.csv', headers, stokesExperimentData);
        });
        
        initializeStokesSim();
    });
  </script>
</body>
</html>
